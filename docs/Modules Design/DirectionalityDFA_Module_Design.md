# DirectionalityDFA — Module Design Document
**File:** `directionality_dfa.py`  
**Date:** 2025-10-03  
**Language:** Python 3.8+  
**Status:** Stable

---

## 1. Abstract
`DirectionalityDFA` classifies a token stream by **who** the message targets: the speaker (**Self**), another person or group (**Others**), or no one in particular (**Generic**). It consumes symbolic tokens produced by preprocessing (e.g., `PRONOUN_SELF`, `PRONOUN_OTHER`, or any other Σ token) and returns a single final label at end of input:
- `qF_Self`, `qF_Others`, or `qF_Generic`.

The automaton is deterministic, single-pass, and minimizes state by promoting at most one of these mutually exclusive directions.

---

## 2. Scope and Non‑Goals
**In scope**
- Recognize directionality based on pronoun-like tokens.
- Choose exactly one final label (`Self`, `Others`, or `Generic`) per input.
- Provide a small and explicit state machine with predictable transitions.

**Out of scope**
- Tokenization logic and keyword maintenance (handled by upstream preprocessing).
- Coreference resolution, sarcasm detection, or discourse parsing.
- Confidence scoring or multi-label outputs.

---

## 3. Glossary
- **Token**: Symbolic label from preprocessing. This DFA expects the following:
  - `PRONOUN_SELF`: first‑person markers (e.g., *I, me, my*).
  - `PRONOUN_OTHER`: second/third‑person markers (e.g., *you, they, them*).
  - Σ (sigma): any other token.
- **Directionality**: The intended target of the message — Self, Others, or Generic.
- **Final label**: One of `qF_Self`, `qF_Others`, `qF_Generic`, produced only by `end_of_input()`.

---

## 4. External Dependencies and Artifacts
- **Standard library**: none beyond Python built‑ins.
- **Inputs**: tokens generated by an upstream tokenizer (e.g., `RegexTokenizer`) using a keywords file.

---

## 5. Public API
### 5.1 Class: `DirectionalityDFA`
**Intent:** Track directionality cues across a token sequence and produce one final category at end of input.

**Constructor**
```python
DirectionalityDFA()
```
- Defines intermediate states: `q0` (start), `q1` (Self detected), `q2` (Others detected), `q3` (Generic).
- Defines final states: `qF_Self`, `qF_Others`, `qF_Generic`.
- Initializes `state = q0`.

**Primary Usage Pattern (Main Behavior)**
There is no single method that processes a whole string; callers feed tokens using `transition()` and then finalize with `end_of_input()`:
```python
dfa = DirectionalityDFA()
for tok in tokens:
    dfa.transition(tok)
label = dfa.end_of_input()   # "qF_Self" | "qF_Others" | "qF_Generic"
```

**Methods**
```python
reset(self) -> None
```
- Sets `state = q0`. Used when reusing the instance across multiple classifications.

```python
transition(self, token: str) -> None
```
- Advances the DFA by one token:
  - `PRONOUN_SELF` → `q1`
  - `PRONOUN_OTHER` → `q2`
  - Otherwise: if currently `q0`, set `q3` (*Generic*). If already in `q1` or `q2`, remain there; do not downgrade to `q3`.

```python
end_of_input(self) -> str
```
- Converts intermediate states to final labels:
  - `q1` → `qF_Self`
  - `q2` → `qF_Others`
  - `q3` → `qF_Generic`
  - Any other state is returned as is (currently `q0` if no tokens were seen).

---

## 6. States and Final Labels
### 6.1 Intermediate States
| State | Meaning |
|---|---|
| `q0` | Start; no evidence seen yet |
| `q1` | Self detected |
| `q2` | Others detected |
| `q3` | Generic content observed (no pronouns yet) |

### 6.2 Final Labels
| Final | Meaning |
|---|---|
| `qF_Self` | Message targets self |
| `qF_Others` | Message targets others |
| `qF_Generic` | Message is generic / no explicit target |

---

## 7. Transition System
### 7.1 Transition Rules (pseudocode)
```text
q0 --PRONOUN_SELF--> q1
q0 --PRONOUN_OTHER--> q2
q0 --Σ-------------> q3

q1 --(any token)--> q1     # sticky Self
q2 --(any token)--> q2     # sticky Others
q3 --PRONOUN_SELF--> q1
q3 --PRONOUN_OTHER--> q2
q3 --Σ-------------> q3
```
- Once `Self` or `Others` is detected, the DFA **does not** revert to `Generic`.
- While in `q3` (Generic), future pronouns can still promote to `q1` or `q2`.

### 7.2 Finalization
```text
end_of_input():
  if state == q1: return qF_Self
  if state == q2: return qF_Others
  if state == q3: return qF_Generic
  return state  # q0 if no tokens were processed
```

---

## 8. Algorithm and Control Flow
```text
reset()
for token in tokens:
  if token == "PRONOUN_SELF":  state = q1
  elif token == "PRONOUN_OTHER": state = q2
  else:
    if state == q0: state = q3
# finalize
return final_label(state)
```
**Determinism**: No randomness; transitions are table‑driven.

---

## 9. Auxiliary Responsibilities (Conceptual Helpers)
Although not split out in code, the following are logical helpers that can be extracted for clarity and testing:

1. **Normalization**
   ```python
   _normalize(token: str) -> str
   # Trim/uppercase/canonicalize token values if upstream is inconsistent.
   ```

2. **Class Predicate**
   ```python
   _is_self(token: str) -> bool      # token == "PRONOUN_SELF"
   _is_other(token: str) -> bool     # token == "PRONOUN_OTHER"
   ```

3. **Promotion Policy**
   ```python
   _promote_generic(current: str) -> str
   # If current == q0 and token ∈ Σ, return q3 else return current.
   ```

4. **Final Mapping**
   ```python
   _finalize(state: str) -> str
   # Implements §7.2 mapping from q1/q2/q3 to qF_*.
   ```

---

## 10. Interfaces and Contracts
### Inputs
- Sequence of tokens (`str`), possibly empty.

### Outputs
- `end_of_input()` returns the final label (`qF_Self` | `qF_Others` | `qF_Generic`). If no tokens are processed, the implementation returns `"q0"`; see §12 for discussion.

### Error Handling
- No exceptions are expected under normal operation. Inputs are plain strings.

### Side Effects
- None. The DFA only mutates its internal `state` attribute.

### Thread Safety
- The instance retains mutable state. Use a dedicated instance per thread/task or guard with external synchronization.

---

## 11. Correctness Arguments
- **Monotonicity**: Detection of `Self` or `Others` is sticky. Once set, it is not downgraded by later tokens, preventing oscillation from late Σ tokens.
- **Totality over typical inputs**: For any non‑empty token sequence, the DFA will end in `q1`, `q2`, or `q3` and thus yield a final label.
- **Compositionality**: Directionality is independent from content classification; this DFA can run in parallel with content DFAs and be combined at end of input.
- **Idempotence**: Reprocessing the same token sequence yields the same final label.

---

## 12. Limitations and Design Trade‑offs
- **Empty input**: If no tokens are seen, `end_of_input()` returns `"q0"` rather than a final label. In combined systems (e.g., `ContentDFA`), ensure either the tokenizer emits at least one Σ token for empty strings or update `end_of_input()` to treat `q0` as `qF_Generic`.
- **Ambiguity**: Mixed signals are simplified to “first signal wins” as implemented; adjust if “last signal wins” is preferred.
- **Locale/Syntax coverage**: The DFA relies entirely on upstream tokenization quality; new pronoun forms require updates to preprocessing.

---

## 13. Test Plan
### 13.1 Unit Tests (pytest)
| ID | Scenario | Tokens | Expected |
|---|---|---|---|
| T1 | Empty input | `[]` | `"q0"` (see §12) |
| T2 | Self single | `["PRONOUN_SELF"]` | `qF_Self` |
| T3 | Others single | `["PRONOUN_OTHER"]` | `qF_Others` |
| T4 | Generic only | `["hello"]` | `qF_Generic` |
| T5 | Self then Σ | `["PRONOUN_SELF","x","y"]` | `qF_Self` |
| T6 | Others then Σ | `["PRONOUN_OTHER","x"]` | `qF_Others` |
| T7 | Σ then Self | `["x","PRONOUN_SELF"]` | `qF_Self` |
| T8 | Σ then Others | `["x","PRONOUN_OTHER"]` | `qF_Others` |
| T9 | Stickiness | `["PRONOUN_SELF","PRONOUN_OTHER"]` | `qF_Self` (current code) |
| T10 | Stickiness 2 | `["PRONOUN_OTHER","PRONOUN_SELF"]` | `qF_Others` (current code) |

---

